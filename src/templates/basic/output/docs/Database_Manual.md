# DevDB Database Manual

*Generated on 2025-07-10 11:44:04*

This document provides comprehensive documentation for the DevDB database schema, including tables, views, functions, and stored procedures.

## Table of Contents

- [Overview](#overview)
- [Database Objects](#database-objects)

## Overview

DevDB is an automated development database deployment system that provides a one-command solution to deploy fresh, containerized SQL Server databases for local development.

## Database Objects



# test_functions.sql

```markdown
# SQL Schema Documentation: test_functions.sql

## Overview

This SQL file contains tSQLt tests for user-defined functions in the `DevDB` database. It includes tests for scalar functions (`CalculateUserAge`, `FormatProductName`) and a table-valued function (`GetActiveProducts`). The tests verify the functions' logic and output.

## Dependencies

-   Database: `DevDB`
-   tSQLt framework

## Tables

This file uses `tSQLt.FakeTable` to create isolated test environments. The following tables are faked during the tests:

### `dbo.Users`

**Purpose:** Represents user data, used for testing the `CalculateUserAge` function.

**Business Logic:** Stores user information, including the creation date, which is used to calculate the user's age in days.

**Columns:**

| Column    | Data Type   | Description                               |
| --------- | ----------- | ----------------------------------------- |
| Username  | VARCHAR(255) | User's username                           |
| Email     | VARCHAR(255) | User's email address                      |
| CreatedAt | DATETIME2   | Timestamp when the user account was created |

**Primary Key:** None (faked table)

**Foreign Keys:** None (faked table)

**Constraints:** None (faked table)

**Indexes:** None (faked table)

### `dbo.Products`

**Purpose:** Represents product data, used for testing the `GetActiveProducts` function.

**Business Logic:** Stores product information, including price and stock levels, which are used to determine active products and calculate their total value.

**Columns:**

| Column      | Data Type     | Description                               |
| ----------- | ------------- | ----------------------------------------- |
| ProductName | VARCHAR(255)  | Name of the product                       |
| Price       | DECIMAL(10,2) | Price of the product                      |
| Stock       | INT           | Current stock level of the product        |

**Primary Key:** None (faked table)

**Foreign Keys:** None (faked table)

**Constraints:** None (faked table)

**Indexes:** None (faked table)

## Stored Procedures (Tests)

This file contains several stored procedures that serve as tSQLt tests. Each procedure tests a specific aspect of a user-defined function.

### `FunctionTests.[test CalculateUserAge returns correct days difference]`

**Purpose:** Tests the `CalculateUserAge` function to ensure it returns the correct age in days based on the user's creation date.

**Business Logic:**
1.  Creates a fake `Users` table.
2.  Inserts a test user with a known creation date.
3.  Calls the `CalculateUserAge` function to calculate the user's age.
4.  Asserts that the calculated age is within an acceptable range (allowing for a 1-day tolerance due to timing).

**Input/Output Parameters:** None

**Error Handling:** Uses `tSQLt.Fail` to report test failures.

**Usage Example:**

```sql
EXEC FunctionTests.[test CalculateUserAge returns correct days difference];
```

### `FunctionTests.[test FormatProductName formats correctly]`

**Purpose:** Tests the `FormatProductName` function to ensure it correctly formats a product name with its price.

**Business Logic:**
1.  Sets up test data, including a product name and price.
2.  Calls the `FormatProductName` function to format the product name.
3.  Asserts that the formatted product name matches the expected format.

**Input/Output Parameters:** None

**Error Handling:** Uses `tSQLt.AssertEquals` to compare the actual and expected results and `tSQLt.Fail` (implicitly through `AssertEquals`) to report test failures.

**Usage Example:**

```sql
EXEC FunctionTests.[test FormatProductName formats correctly];
```

### `FunctionTests.[test GetActiveProducts returns products with stock greater than minimum]`

**Purpose:** Tests the `GetActiveProducts` table-valued function to ensure it returns products with stock levels greater than the specified minimum.

**Business Logic:**
1.  Creates a fake `Products` table.
2.  Inserts test products with different stock levels.
3.  Calls the `GetActiveProducts` function with a minimum stock level of 0.
4.  Asserts that the function returns the correct number of active products (products with stock > 0).

**Input/Output Parameters:** None

**Error Handling:** Uses `tSQLt.AssertEquals` to compare the actual and expected results and `tSQLt.Fail` (implicitly through `AssertEquals`) to report test failures.

**Usage Example:**

```sql
EXEC FunctionTests.[test GetActiveProducts returns products with stock greater than minimum];
```

### `FunctionTests.[test GetActiveProducts respects minimum stock parameter]`

**Purpose:** Tests the `GetActiveProducts` table-valued function to ensure it correctly respects the minimum stock parameter.

**Business Logic:**
1.  Creates a fake `Products` table.
2.  Inserts test products with different stock levels.
3.  Calls the `GetActiveProducts` function with a minimum stock level of 10.
4.  Asserts that the function returns the correct number of active products (products with stock > 10).

**Input/Output Parameters:** None

**Error Handling:** Uses `tSQLt.AssertEquals` to compare the actual and expected results and `tSQLt.Fail` (implicitly through `AssertEquals`) to report test failures.

**Usage Example:**

```sql
EXEC FunctionTests.[test GetActiveProducts respects minimum stock parameter];
```

### `FunctionTests.[test GetActiveProducts calculates total value correctly]`

**Purpose:** Tests the `GetActiveProducts` table-valued function to ensure it correctly calculates the total value of active products (Price \* Stock).

**Business Logic:**
1.  Creates a fake `Products` table.
2.  Inserts a test product with a known price and stock level.
3.  Calls the `GetActiveProducts` function with a minimum stock level of 0.
4.  Asserts that the function returns the correct total value for the product.

**Input/Output Parameters:** None

**Error Handling:** Uses `tSQLt.AssertEquals` to compare the actual and expected results and `tSQLt.Fail` (implicitly through `AssertEquals`) to report test failures.

**Usage Example:**

```sql
EXEC FunctionTests.[test GetActiveProducts calculates total value correctly];
```
```

---



# test_product_stock_fail.sql

```markdown
# SQL Schema Documentation: test_product_stock_fail.sql

## Overview

This SQL file contains a suite of tSQLt tests designed to intentionally fail. These tests are used to demonstrate and validate tSQLt's error handling and assertion capabilities. The tests cover various failure scenarios, including assertion failures, exception expectation failures, string comparison failures, range assertion failures, table content failures, and null assertion failures. All tests are part of the `IntentionalFailureTests` test class.

## Dependencies

-   This file depends on the `tSQLt` framework being installed in the `DevDB` database.
-   It also depends on the `DevDB` database existing.

## Tables

This file uses fake tables created by `tSQLt.FakeTable`.  The primary table used is `dbo.Products`.

### dbo.Products (Fake Table)

**Purpose and Business Logic:**

This table is a fake table created within the scope of the tSQLt tests. It simulates a real `Products` table for testing purposes. It stores information about products, including their name, price, and stock level.

**Column Descriptions:**

| Column Name    | Data Type       | Description                               |
| -------------- | --------------- | ----------------------------------------- |
| ProductName    | NVARCHAR(100)   | The name of the product.                  |
| Price          | DECIMAL(10, 2)  | The price of the product.                 |
| Stock          | INT             | The current stock level of the product.   |

**Primary Keys, Foreign Keys, and Constraints:**

-   This is a fake table, so no explicit primary keys or constraints are defined in this script. However, the tests implicitly rely on the existence of these columns.

**Indexes:**

-   No indexes are explicitly created in this script, as it's a fake table.

## Stored Procedures

This file defines several stored procedures, each representing a test case within the `IntentionalFailureTests` test class.

### IntentionalFailureTests.[test product stock assertion fails intentionally]

**Purpose and Business Logic:**

This test case intentionally fails an assertion to demonstrate tSQLt's failure handling. It creates a fake `Products` table, inserts a product with a known stock level, and then asserts that the stock level is a different value.

**Input/Output Parameters:**

This procedure does not have any input or output parameters.

**Error Handling Approach:**

The test relies on tSQLt's assertion mechanism (`tSQLt.AssertEquals`) to detect and report the failure.

**Usage Example:**

```sql
EXEC IntentionalFailureTests.[test product stock assertion fails intentionally];
```

**Code:**

```sql
CREATE PROCEDURE IntentionalFailureTests.[test product stock assertion fails intentionally]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';
    
    -- Insert test product with known stock level
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES ('Test Widget', 19.99, 10);
    
    -- Act: Get the actual stock level
    DECLARE @ActualStock INT;
    SELECT @ActualStock = Stock FROM dbo.Products WHERE ProductName = 'Test Widget';
    
    -- Assert: Intentionally check for wrong stock level (this will fail)
    EXEC tSQLt.AssertEquals @Expected = 5, @Actual = @ActualStock, 
         @Message = 'INTENTIONAL FAILURE: Expected stock to be 5, but it was 10. This test demonstrates tSQLt failure handling.';
END;
GO
```

### IntentionalFailureTests.[test exception expectation fails when no exception thrown]

**Purpose and Business Logic:**

This test case intentionally fails by expecting an exception that is never thrown. It uses `tSQLt.ExpectException` to specify an expected exception message pattern, but the subsequent code does not raise any exceptions.

**Input/Output Parameters:**

This procedure does not have any input or output parameters.

**Error Handling Approach:**

The test relies on `tSQLt.ExpectException` to detect the absence of the expected exception and report the failure.

**Usage Example:**

```sql
EXEC IntentionalFailureTests.[test exception expectation fails when no exception thrown];
```

**Code:**

```sql
CREATE PROCEDURE IntentionalFailureTests.[test exception expectation fails when no exception thrown]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';
    
    -- Act & Assert: Expect an exception that won't be thrown
    EXEC tSQLt.ExpectException @ExpectedMessagePattern = '%This exception will never be thrown%';
    
    -- This simple statement won't throw an exception, causing the test to fail
    SELECT 1 AS SimpleSelect;
END;
GO
```

### IntentionalFailureTests.[test string comparison fails intentionally]

**Purpose and Business Logic:**

This test case intentionally fails a string comparison assertion. It sets up two different string values and then uses `tSQLt.AssertEquals` to compare them, resulting in a failure.

**Input/Output Parameters:**

This procedure does not have any input or output parameters.

**Error Handling Approach:**

The test relies on `tSQLt.AssertEquals` to detect the string comparison failure and report it.

**Usage Example:**

```sql
EXEC IntentionalFailureTests.[test string comparison fails intentionally];
```

**Code:**

```sql
CREATE PROCEDURE IntentionalFailureTests.[test string comparison fails intentionally]
AS
BEGIN
    -- Arrange: Set up test data
    DECLARE @ActualValue NVARCHAR(50) = 'Hello World';
    DECLARE @ExpectedValue NVARCHAR(50) = 'Goodbye World';
    
    -- Act & Assert: Intentionally compare different strings
    EXEC tSQLt.AssertEquals @Expected = @ExpectedValue, @Actual = @ActualValue, 
         @Message = 'INTENTIONAL FAILURE: Demonstrating string comparison failure in tSQLt.';
END;
GO
```

### IntentionalFailureTests.[test range assertion fails intentionally]

**Purpose and Business Logic:**

This test case intentionally fails a range assertion. It sets up a value and then uses a conditional statement to check if the value falls within a specific range. Since the value is outside the range, the `tSQLt.Fail` procedure is called to report the failure.

**Input/Output Parameters:**

This procedure does not have any input or output parameters.

**Error Handling Approach:**

The test relies on a conditional statement and `tSQLt.Fail` to detect and report the range assertion failure.

**Usage Example:**

```sql
EXEC IntentionalFailureTests.[test range assertion fails intentionally];
```

**Code:**

```sql
CREATE PROCEDURE IntentionalFailureTests.[test range assertion fails intentionally]
AS
BEGIN
    -- Arrange: Set up test value
    DECLARE @ActualValue INT = 25;
    
    -- Act & Assert: Intentionally check if value is in wrong range
    IF @ActualValue >= 10 AND @ActualValue <= 20
    BEGIN
        EXEC tSQLt.Fail 'INTENTIONAL FAILURE: Value 25 is not between 10 and 20. This demonstrates range assertion failure.';
    END;
END;
GO
```

### IntentionalFailureTests.[test table content assertion fails intentionally]

**Purpose and Business Logic:**

This test case intentionally fails a table content assertion. It creates a fake `Products` table, inserts some data, and then creates a temporary table (`#ExpectedProducts`) with different data. Finally, it uses `tSQLt.AssertEqualsTable` to compare the two tables, resulting in a failure due to the differences in their contents.

**Input/Output Parameters:**

This procedure does not have any input or output parameters.

**Error Handling Approach:**

The test relies on `tSQLt.AssertEqualsTable` to detect the differences in table contents and report the failure.

**Usage Example:**

```sql
EXEC IntentionalFailureTests.[test table content assertion fails intentionally];
```

**Code:**

```sql
CREATE PROCEDURE IntentionalFailureTests.[test table content assertion fails intentionally]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';
    
    -- Insert actual data
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES 
    ('Product A', 10.00, 5),
    ('Product B', 20.00, 10);
    
    -- Create expected table with different data
    CREATE TABLE #ExpectedProducts (ProductName NVARCHAR(100), Price DECIMAL(10,2), Stock INT);
    INSERT INTO #ExpectedProducts VALUES 
    ('Product A', 15.00, 5),  -- Different price
    ('Product C', 20.00, 10); -- Different product name
    
    -- Act & Assert: Compare tables (this will fail due to differences)
    EXEC tSQLt.AssertEqualsTable @Expected = '#ExpectedProducts', @Actual = 'dbo.Products', 
         @Message = 'INTENTIONAL FAILURE: Table contents do not match. This demonstrates table comparison failure.';
END;
GO
```

### IntentionalFailureTests.[test null assertion fails intentionally]

**Purpose and Business Logic:**

This test case intentionally fails a null assertion. It sets up a non-null value and then uses `tSQLt.AssertEquals` to assert that the value is null, resulting in a failure.

**Input/Output Parameters:**

This procedure does not have any input or output parameters.

**Error Handling Approach:**

The test relies on `tSQLt.AssertEquals` to detect the null assertion failure and report it.

**Usage Example:**

```sql
EXEC IntentionalFailureTests.[test null assertion fails intentionally];
```

**Code:**

```sql
CREATE PROCEDURE IntentionalFailureTests.[test null assertion fails intentionally]
AS
BEGIN
    -- Arrange: Create a non-null value
    DECLARE @ActualValue NVARCHAR(50) = 'This is not null';
    
    -- Act & Assert: Intentionally assert that a non-null value is null
    EXEC tSQLt.AssertEquals @Expected = NULL, @Actual = @ActualValue, 
         @Message = 'INTENTIONAL FAILURE: Expected NULL but got a non-null value. This demonstrates null assertion failure.';
END;
GO
```


---



# test_stored_procedures.sql

```markdown
# SQL Schema Documentation: test_stored_procedures.sql

## Overview

This SQL file contains tSQLt unit tests for two stored procedures: `ManageProductInventory` and `CreateUserWithValidation`. These tests ensure that the stored procedures function correctly under various conditions, including valid inputs, error handling, and constraint enforcement. The tests use fake tables to isolate the stored procedures and prevent unintended side effects on the actual database.

## Dependencies

This file depends on:

*   `tSQLt` framework for unit testing.
*   The existence of the `DevDB` database.
*   The existence of the stored procedures `dbo.ManageProductInventory` and `dbo.CreateUserWithValidation`.
*   The existence of the tables `dbo.Products` and `dbo.Users`.

Other files that may depend on this file:

*   None. This is a test file.

## Test Class: StoredProcedureTests

The tests are organized within a tSQLt test class named `StoredProcedureTests`.

```sql
EXEC tSQLt.NewTestClass @ClassName = 'StoredProcedureTests';
GO
```

## Stored Procedure Tests

### 1. `[test ManageProductInventory ADD action increases stock correctly]`

**Purpose:** Tests the `ManageProductInventory` stored procedure's `ADD` action.  Verifies that adding a quantity to the product's stock increases the stock level correctly.

**Logic:**

1.  Creates a fake `Products` table using `tSQLt.FakeTable`.
2.  Inserts a test product with an initial stock level of 50.
3.  Executes `ManageProductInventory` with the `ADD` action, adding a quantity of 10.
4.  Asserts that the `@NewStock` output parameter is equal to 60.

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test ManageProductInventory ADD action increases stock correctly]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';

    -- Insert test product with known stock
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES ('SP Test Product', 19.99, 50);
    DECLARE @ProductID INT = SCOPE_IDENTITY();

    -- Act: Execute the ADD action
    DECLARE @NewStock INT;
    EXEC dbo.ManageProductInventory @ProductID = @ProductID, @Action = 'ADD', @Quantity = 10, @NewStock = @NewStock OUTPUT;

    -- Assert: Check the new stock value
    EXEC tSQLt.AssertEquals @Expected = 60, @Actual = @NewStock,
         @Message = 'ManageProductInventory ADD action should increase stock by quantity';
END;
GO
```

### 2. `[test ManageProductInventory REMOVE action decreases stock correctly]`

**Purpose:** Tests the `ManageProductInventory` stored procedure's `REMOVE` action.  Verifies that removing a quantity from the product's stock decreases the stock level correctly.

**Logic:**

1.  Creates a fake `Products` table using `tSQLt.FakeTable`.
2.  Inserts a test product with an initial stock level of 50.
3.  Executes `ManageProductInventory` with the `REMOVE` action, removing a quantity of 20.
4.  Asserts that the `@NewStock` output parameter is equal to 30.

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test ManageProductInventory REMOVE action decreases stock correctly]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';

    -- Insert test product with known stock
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES ('SP Test Product', 19.99, 50);
    DECLARE @ProductID INT = SCOPE_IDENTITY();

    -- Act: Execute the REMOVE action
    DECLARE @NewStock INT;
    EXEC dbo.ManageProductInventory @ProductID = @ProductID, @Action = 'REMOVE', @Quantity = 20, @NewStock = @NewStock OUTPUT;

    -- Assert: Check the new stock value
    EXEC tSQLt.AssertEquals @Expected = 30, @Actual = @NewStock,
         @Message = 'ManageProductInventory REMOVE action should decrease stock by quantity';
END;
GO
```

### 3. `[test ManageProductInventory SET action sets stock to exact value]`

**Purpose:** Tests the `ManageProductInventory` stored procedure's `SET` action.  Verifies that setting the stock level to a specific quantity works correctly.

**Logic:**

1.  Creates a fake `Products` table using `tSQLt.FakeTable`.
2.  Inserts a test product with an initial stock level of 50.
3.  Executes `ManageProductInventory` with the `SET` action, setting the stock level to 100.
4.  Asserts that the `@NewStock` output parameter is equal to 100.

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test ManageProductInventory SET action sets stock to exact value]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';

    -- Insert test product with known stock
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES ('SP Test Product', 19.99, 50);
    DECLARE @ProductID INT = SCOPE_IDENTITY();

    -- Act: Execute the SET action
    DECLARE @NewStock INT;
    EXEC dbo.ManageProductInventory @ProductID = @ProductID, @Action = 'SET', @Quantity = 100, @NewStock = @NewStock OUTPUT;

    -- Assert: Check the new stock value
    EXEC tSQLt.AssertEquals @Expected = 100, @Actual = @NewStock,
         @Message = 'ManageProductInventory SET action should set stock to exact quantity';
END;
GO
```

### 4. `[test ManageProductInventory throws error on insufficient stock]`

**Purpose:** Tests the `ManageProductInventory` stored procedure's error handling when attempting to remove more stock than available.

**Logic:**

1.  Creates a fake `Products` table using `tSQLt.FakeTable`.
2.  Inserts a test product with a low stock level of 10.
3.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50002 and a message containing "Insufficient stock" is raised.
4.  Executes `ManageProductInventory` with the `REMOVE` action, attempting to remove a quantity of 20.

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test ManageProductInventory throws error on insufficient stock]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';

    -- Insert test product with low stock
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES ('SP Test Product', 19.99, 10);
    DECLARE @ProductID INT = SCOPE_IDENTITY();

    -- Act & Assert: Expect error when trying to remove more stock than available
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50002,
         @ExpectedMessagePattern = '%Insufficient stock%';

    DECLARE @NewStock INT;
    EXEC dbo.ManageProductInventory @ProductID = @ProductID, @Action = 'REMOVE', @Quantity = 20, @NewStock = @NewStock OUTPUT;
END;
GO
```

### 5. `[test ManageProductInventory throws error on invalid action]`

**Purpose:** Tests the `ManageProductInventory` stored procedure's error handling when an invalid action is provided.

**Logic:**

1.  Creates a fake `Products` table using `tSQLt.FakeTable`.
2.  Inserts a test product.
3.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50003 and a message containing "Invalid action" is raised.
4.  Executes `ManageProductInventory` with an invalid action ('INVALID').

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test ManageProductInventory throws error on invalid action]
AS
BEGIN
    -- Arrange: Create fake Products table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';

    -- Insert test product
    INSERT INTO dbo.Products (ProductName, Price, Stock) VALUES ('SP Test Product', 19.99, 50);
    DECLARE @ProductID INT = SCOPE_IDENTITY();

    -- Act & Assert: Expect error when using invalid action
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50003,
         @ExpectedMessagePattern = '%Invalid action%';

    DECLARE @NewStock INT;
    EXEC dbo.ManageProductInventory @ProductID = @ProductID, @Action = 'INVALID', @Quantity = 10, @NewStock = @NewStock OUTPUT;
END;
GO
```

### 6. `[test ManageProductInventory throws error when product not found]`

**Purpose:** Tests the `ManageProductInventory` stored procedure's error handling when the specified product ID does not exist.

**Logic:**

1.  Creates a fake `Products` table using `tSQLt.FakeTable`.  The table is empty.
2.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50001 and a message containing "Product with ID" and "not found" is raised.
3.  Executes `ManageProductInventory` with a non-existent product ID (999).

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test ManageProductInventory throws error when product not found]
AS
BEGIN
    -- Arrange: Create fake Products table (empty)
    EXEC tSQLt.FakeTable @TableName = 'dbo.Products';

    -- Act & Assert: Expect error when product doesn't exist
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50001,
         @ExpectedMessagePattern = '%Product with ID%not found%';

    DECLARE @NewStock INT;
    EXEC dbo.ManageProductInventory @ProductID = 999, @Action = 'ADD', @Quantity = 10, @NewStock = @NewStock OUTPUT;
END;
GO
```

### 7. `[test CreateUserWithValidation creates user successfully]`

**Purpose:** Tests the `CreateUserWithValidation` stored procedure's successful user creation.

**Logic:**

1.  Creates a fake `Users` table using `tSQLt.FakeTable`.
2.  Executes `CreateUserWithValidation` with valid username and email.
3.  Asserts that the `@NewUserID` output parameter is not 0, indicating a successful user creation.
4.  Verifies that a user with the specified username exists in the `Users` table.

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test CreateUserWithValidation creates user successfully]
AS
BEGIN
    -- Arrange: Create fake Users table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Users';

    -- Act: Execute the procedure
    DECLARE @NewUserID INT;
    EXEC dbo.CreateUserWithValidation @Username = 'sptest_user', @Email = 'sptest@example.com', @NewUserID = @NewUserID OUTPUT;

    -- Assert: Check that user was created and ID was returned
    EXEC tSQLt.AssertNotEquals @Expected = 0, @Actual = @NewUserID,
         @Message = 'CreateUserWithValidation should return a valid user ID';

    -- Verify user exists in table
    DECLARE @UserCount INT;
    SELECT @UserCount = COUNT(*) FROM dbo.Users WHERE Username = 'sptest_user';
    EXEC tSQLt.AssertEquals @Expected = 1, @Actual = @UserCount,
         @Message = 'CreateUserWithValidation should insert exactly one user';
END;
GO
```

### 8. `[test CreateUserWithValidation throws error when username too short]`

**Purpose:** Tests the `CreateUserWithValidation` stored procedure's validation for username length.

**Logic:**

1.  Creates a fake `Users` table using `tSQLt.FakeTable`.
2.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50004 and a message containing "Username must be at least 3 characters" is raised.
3.  Executes `CreateUserWithValidation` with a username that is too short ('ab').

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test CreateUserWithValidation throws error when username too short]
AS
BEGIN
    -- Arrange: Create fake Users table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Users';

    -- Act & Assert: Expect error for username too short
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50004,
         @ExpectedMessagePattern = '%Username must be at least 3 characters%';

    DECLARE @NewUserID INT;
    EXEC dbo.CreateUserWithValidation @Username = 'ab', @Email = 'short@example.com', @NewUserID = @NewUserID OUTPUT;
END;
GO
```

### 9. `[test CreateUserWithValidation throws error on invalid email format]`

**Purpose:** Tests the `CreateUserWithValidation` stored procedure's validation for email format.

**Logic:**

1.  Creates a fake `Users` table using `tSQLt.FakeTable`.
2.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50005 and a message containing "Invalid email format" is raised.
3.  Executes `CreateUserWithValidation` with an invalid email format ('invalidemail').

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test CreateUserWithValidation throws error on invalid email format]
AS
BEGIN
    -- Arrange: Create fake Users table
    EXEC tSQLt.FakeTable @TableName = 'dbo.Users';

    -- Act & Assert: Expect error for invalid email format
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50005,
         @ExpectedMessagePattern = '%Invalid email format%';

    DECLARE @NewUserID INT;
    EXEC dbo.CreateUserWithValidation @Username = 'test_invalid_email', @Email = 'invalidemail', @NewUserID = @NewUserID OUTPUT;
END;
GO
```

### 10. `[test CreateUserWithValidation throws error on duplicate username]`

**Purpose:** Tests the `CreateUserWithValidation` stored procedure's handling of duplicate usernames.

**Logic:**

1.  Creates a fake `Users` table using `tSQLt.FakeTable`.
2.  Inserts an existing user into the `Users` table.
3.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50006 and a message containing "Username already exists" is raised.
4.  Executes `CreateUserWithValidation` with a duplicate username ('existing\_user').

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test CreateUserWithValidation throws error on duplicate username]
AS
BEGIN
    -- Arrange: Create fake Users table with existing user
    EXEC tSQLt.FakeTable @TableName = 'dbo.Users';
    INSERT INTO dbo.Users (Username, Email) VALUES ('existing_user', 'existing@example.com');

    -- Act & Assert: Expect error for duplicate username
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50006,
         @ExpectedMessagePattern = '%Username already exists%';

    DECLARE @NewUserID INT;
    EXEC dbo.CreateUserWithValidation @Username = 'existing_user', @Email = 'different@example.com', @NewUserID = @NewUserID OUTPUT;
END;
GO
```

### 11. `[test CreateUserWithValidation throws error on duplicate email]`

**Purpose:** Tests the `CreateUserWithValidation` stored procedure's handling of duplicate email addresses.

**Logic:**

1.  Creates a fake `Users` table using `tSQLt.FakeTable`.
2.  Inserts an existing user into the `Users` table.
3.  Uses `tSQLt.ExpectException` to assert that an exception with error number 50007 and a message containing "Email already exists" is raised.
4.  Executes `CreateUserWithValidation` with a duplicate email address ('existing@example.com').

**SQL:**

```sql
CREATE PROCEDURE StoredProcedureTests.[test CreateUserWithValidation throws error on duplicate email]
AS
BEGIN
    -- Arrange: Create fake Users table with existing user
    EXEC tSQLt.FakeTable @TableName = 'dbo.Users';
    INSERT INTO dbo.Users (Username, Email) VALUES ('existing_user', 'existing@example.com');

    -- Act & Assert: Expect error for duplicate email
    EXEC tSQLt.ExpectException @ExpectedErrorNumber = 50007,
         @ExpectedMessagePattern = '%Email already exists%';

    DECLARE @NewUserID INT;
    EXEC dbo.CreateUserWithValidation @Username = 'different_user', @Email = 'existing@example.com', @NewUserID = @NewUserID OUTPUT;
END;
GO
```


---



# test_user_creation.sql

```markdown
# Documentation for `test_user_creation.sql`

## Overview

This SQL file contains tSQLt tests for the `AddNewUser` stored procedure. The tests verify that the `AddNewUser` procedure correctly creates users in the `Users` table, sets the `CreatedAt` timestamp, handles special characters and international email domains, generates sequential `UserID` values, and handles NULL and empty username parameters (documenting current behavior). The tests use a fake `Users` table created by `tSQLt.FakeTable` to isolate the tests.

## Tables

This file focuses on testing the `AddNewUser` stored procedure's interaction with the `Users` table.  Since the tests use `tSQLt.FakeTable`, the actual structure of the `Users` table is not defined in this file. However, the tests implicitly assume the following columns exist:

### `Users` (Fake Table)

**Purpose and Business Logic:**

This table (or rather, a fake version of it) is used to store user information. The tests assume it exists and has specific columns. The business logic is that each user should have a unique `UserID`, a `Username`, an `Email`, and a `CreatedAt` timestamp.

**Column Descriptions:**

| Column Name | Data Type      | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
| Column Name | Data Type   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
| `UserID`    | `INT`         | The unique identifier for the user.  Likely an identity column.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
| `Username`  | `NVARCHAR(50)` | The username of the user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

---



# test_views.sql

```markdown
# SQL Schema Documentation: test_views.sql

## Overview

This SQL file contains tSQLt tests designed to validate the functionality and correctness of various views within the `DevDB` database. The tests cover aspects such as data categorization, calculation accuracy, data inclusion, and the proper interaction of views in complex queries. The tests utilize fake tables to isolate the view logic and ensure reliable results.

## Dependencies

This file depends on:

*   `DevDB` database existing.
*   `tSQLt` framework being installed.
*   The existence of the tables `dbo.Users` and `dbo.Products` (although these are faked during the tests).
*   The existence of the views `dbo.UserStats`, `dbo.ProductAnalytics`, and `dbo.UserProductSummary` (these are the targets of the tests).

What depends on this file:

*   The stability and reliability of the `dbo.UserStats`, `dbo.ProductAnalytics`, and `dbo.UserProductSummary` views. Any changes to these views should be accompanied by re-running these tests.

## Test Classes

### ViewTests

This test class contains all the tests for the views.

## Stored Procedures (Tests)

### ViewTests.[test UserStats view categorizes users by activity correctly]

**Purpose:**

This test verifies that the `dbo.UserStats` view correctly categorizes users into "New", "Regular", and "Veteran" categories based on their account creation date.

**Business Logic:**

The test creates fake `dbo.Users` data with users created at different times. It then queries the `dbo.UserStats` view and asserts that the number of users in each category matches the expected values.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the actual number of users in each category matches the expected number. If the assertion fails, a message is displayed indicating the specific categorization error.

**Usage Example:**

```sql
EXEC ViewTests.[test UserStats view categorizes users by activity correctly];
```

### ViewTests.[test UserStats view calculates DaysActive correctly]

**Purpose:**

This test validates that the `dbo.UserStats` view accurately calculates the number of days a user has been active (i.e., the difference between the current date and the user's account creation date).

**Business Logic:**

The test creates a fake `dbo.Users` table and inserts a user with a known creation date. It then queries the `dbo.UserStats` view to retrieve the `DaysActive` value for that user and asserts that the calculated value is within a reasonable tolerance (1 day) of the expected value.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test checks if the calculated `DaysActive` value is within the acceptable range (99 to 101 days). If the value falls outside this range, the test fails with a message indicating that the `DaysActive` calculation is incorrect.

**Usage Example:**

```sql
EXEC ViewTests.[test UserStats view calculates DaysActive correctly];
```

### ViewTests.[test ProductAnalytics view categorizes stock levels correctly]

**Purpose:**

This test ensures that the `dbo.ProductAnalytics` view correctly categorizes products into "Out of Stock", "Low Stock", "Medium Stock", and "High Stock" categories based on their stock levels.

**Business Logic:**

The test creates a fake `dbo.Products` table and inserts products with different stock levels. It then queries the `dbo.ProductAnalytics` view and asserts that the number of products in each category matches the expected values.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the actual number of products in each category matches the expected number. If the assertion fails, a message is displayed indicating the specific categorization error.

**Usage Example:**

```sql
EXEC ViewTests.[test ProductAnalytics view categorizes stock levels correctly];
```

### ViewTests.[test ProductAnalytics view calculates inventory value correctly]

**Purpose:**

This test verifies that the `dbo.ProductAnalytics` view accurately calculates the inventory value of a product (i.e., the product of its price and stock level).

**Business Logic:**

The test creates a fake `dbo.Products` table and inserts a product with known price and stock values. It then queries the `dbo.ProductAnalytics` view to retrieve the `InventoryValue` for that product and asserts that the calculated value matches the expected value.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the calculated `InventoryValue` matches the expected value. If the assertion fails, a message is displayed indicating that the `InventoryValue` calculation is incorrect.

**Usage Example:**

```sql
EXEC ViewTests.[test ProductAnalytics view calculates inventory value correctly];
```

### ViewTests.[test ProductAnalytics view formats display name correctly]

**Purpose:**

This test validates that the `dbo.ProductAnalytics` view correctly formats the display name of a product, including the product name and price. It assumes the existence of a function named `FormatProductName` that is used to format the display name.

**Business Logic:**

The test creates a fake `dbo.Products` table and inserts a product with a known name and price. It then queries the `dbo.ProductAnalytics` view to retrieve the `DisplayName` for that product and asserts that the formatted display name matches the expected value.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the formatted `DisplayName` matches the expected value. If the assertion fails, a message is displayed indicating that the display name formatting is incorrect.

**Usage Example:**

```sql
EXEC ViewTests.[test ProductAnalytics view formats display name correctly];
```

### ViewTests.[test UserProductSummary view includes all users]

**Purpose:**

This test ensures that the `dbo.UserProductSummary` view includes data for all users, even if they don't have any associated product information.

**Business Logic:**

The test creates fake `dbo.Users` and `dbo.Products` tables and inserts multiple users and products. It then queries the `dbo.UserProductSummary` view and asserts that the number of rows returned matches the number of users.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the number of rows returned by the `dbo.UserProductSummary` view matches the number of users. If the assertion fails, a message is displayed indicating that the view is not including data for all users.

**Usage Example:**

```sql
EXEC ViewTests.[test UserProductSummary view includes all users];
```

### ViewTests.[test UserProductSummary view calculates product metrics correctly]

**Purpose:**

This test validates that the `dbo.UserProductSummary` view accurately calculates product metrics such as the number of products, average price, and total inventory value.

**Business Logic:**

The test creates fake `dbo.Users` and `dbo.Products` tables and inserts a user and multiple products with known values. It then queries the `dbo.UserProductSummary` view to retrieve the `ProductCount`, `AveragePrice`, and `TotalInventoryValue` for that user and asserts that the calculated values match the expected values.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the calculated `ProductCount`, `AveragePrice`, and `TotalInventoryValue` match the expected values. If the assertion fails, a message is displayed indicating the specific calculation error.

**Usage Example:**

```sql
EXEC ViewTests.[test UserProductSummary view calculates product metrics correctly];
```

### ViewTests.[test complex query with multiple views works correctly]

**Purpose:**

This test verifies that a complex query that joins multiple views (`dbo.UserStats` and `dbo.ProductAnalytics`) works correctly and returns the expected results.

**Business Logic:**

The test creates fake `dbo.Users` and `dbo.Products` tables and inserts users with different categories and a high-value product. It then executes a complex query that joins `dbo.UserStats` with a subquery on `dbo.ProductAnalytics` to count the number of high-value products. The query filters users based on their category and asserts that the number of rows returned matches the expected value.

**Input/Output Parameters:**

This stored procedure does not have any input or output parameters.

**Error Handling:**

The test uses `tSQLt.AssertEquals` to check if the number of rows returned by the complex query matches the expected value. If the assertion fails, a message is displayed indicating that the query is not working correctly.

**Usage Example:**

```sql
EXEC ViewTests.[test complex query with multiple views works correctly];
```
```

---

